select *,
    case when total_orders > 20 then 1 else 0 end as more_than_20_orders,
    case when supermarket_orders>0 and express_orders=0 and rest_of_ng_orders=0 then 'Supermercados only'
        when supermarket_orders=0  and express_orders>0 and rest_of_ng_orders=0 then 'Express only'
        when supermarket_orders=0  and express_orders=0 and rest_of_ng_orders>0 then 'Rest-of-NG only'
        when supermarket_orders>0  and express_orders>0 and rest_of_ng_orders>0 then 'Bought all'
        when supermarket_orders>0  and express_orders>0 and rest_of_ng_orders=0 then 'Super + Express'
        when supermarket_orders>0  and express_orders=0 and rest_of_ng_orders>0 then 'Super + Rest-of-NG'
        when supermarket_orders=0  and express_orders>0 and rest_of_ng_orders>0 then 'Express + Rest-of-NG'
        else 'what?' end as user_type
from
    (select
        u.id as user_id,
        u.email,
        case when date_trunc('month', coalesce(u.date_first_order, u.created)) = order_month then 1 else 0 end as is_new_user,
        sum(ordered) as ordered,
        sum(found) as found,
        sum(replaced) as replaced,
        count(distinct order_id) as total_orders,
        count(distinct order_id) filter (where order_pop) as pop_orders,
        count(distinct order_id) filter (where order_platform = 'Uber') as uber_orders,
        count(distinct order_id) filter (where store_group = 'Supermarket') as supermarket_orders,
        count(distinct order_id) filter (where store_group = 'Express') as express_orders,
        count(distinct order_id) filter (where store_group = 'Rest of NonG') as rest_of_ng_orders,
        coalesce(sum(merchant_payment), 0) as total_gmv,
        coalesce(sum(merchant_payment) filter (where store_group = 'Supermarket'), 0) as supermarket_gmv,
        coalesce(sum(merchant_payment) filter (where store_group = 'Express'), 0) as express_gmv,
        coalesce(sum(merchant_payment) filter (where store_group = 'Rest of NonG'), 0) as rest_of_ng_gmv
    from
        (select
            distinct o.id as order_id,
            date_trunc('month', o.actual_delivery_time at time zone sb.timezone) as order_month,
            o.user_id,
            o.total_receipt as merchant_payment,
            o.with_subscription as order_pop,
            case when o.platform = 0 and (o.client_bundle like '%uber%' or (o.client_bundle is null and u.tmp_uber_original_segmentation = 'Uber')) then 'Uber' else 'Cornershop' end as order_platform,
            case when sc.id in (4,14,16) then 'Express'
                when sc.id = 13 then 'Supermarket' 
                else 'Rest of NonG' end as store_group,
            o.qty_products_ordered as ordered,
            o.qty_products_found as found,
            o.qty_products_replaced as replaced
        from orders_order o
            join crm_users_view u on u.id = o.user_id
            join catalog_storebranch sb on sb.id = o.store_branch_id
            join catalog_store s on s.id = sb.store_id
            left join catalog_storecollectionitem sci on sci.store_id = s.id
            left join catalog_storecollection sc on sc.id = sci.collection_id
        where 1=1
            and o.actual_delivery_time >= {{desde}} - interval '2 day'
            and o.actual_delivery_time < {{hasta}} + interval '2 day'
            and o.actual_delivery_time at time zone sb.timezone >= {{desde}}
            and o.actual_delivery_time at time zone sb.timezone < {{hasta}} + interval '1 day'
            and o.currency = 'MXN'
            and o.order_kind = 'NORMAL'
            and o.status = 'DELIVERED'
            and s.country = 'MX'
            and s.status = 'ACTIVE'
        ) a 
        join crm_users_view u on u.id = a.user_id
    group by 1,2,3
    ) b
