/*Quiero sacar una data en especifico para una CPG: 
Por pedido para la tienda HEB cuál es el sabor de unas barras de chocolate de la marca Lindt que más meten en su carrito
pero la data literal es por pedido*/

select 
    p.id as product_id,
    p.name as product_name,
    unnest(p.barcodes) as barcodes,
    count(distinct op.order_id) as total_orders
from orders_orderproduct op
    join orders_order o on o.id = op.order_id
    join catalog_product p on p.id = op.product_id
    join catalog_brand b on b.id = p.brand_id
    join catalog_storebranch sb on sb.id = o.shopper_store_branch_id
where 1=1
    and b.name ilike '%lindt%'
    and sb.store_id = {{store_id}}
    and p.currency = 'MXN'
    and o.currency = 'MXN'
    and o.actual_delivery_time >= {{desde}} - interval '1 day' 
    and o.actual_delivery_time < {{hasta}} + interval '2 day'
    and o.actual_delivery_time at time zone sb.timezone between {{desde}} and {{hasta}} + interval '1 day'
    and o.status = 'DELIVERED'
    and o.order_kind = 'NORMAL'
group by 1,2,3
order by 4 desc;
