select
    total_cart + sh_paid + pop_subscriptions as gmv,
    total_cart + sh_paid + pop_subscriptions + partner_commission - (merchant_payment + customer_refunds + credits_refunds) as revenue,
    processing_fees + shopper_commission + shopper_extra_commission_adj + replacement_calls + ad_revenue_cost + bags as costs
from
    (select 
        a.*,
        b.ad_revenue_cost,
        coalesce(c.post_sale_refunds,0) as post_sale_refunds,
        a.cash_refunds + coalesce(c.post_sale_refunds,0) as customer_refunds,
        d.shopper_extra_commission_total*a.shopper_commission / sum(a.shopper_commission) over () as shopper_extra_commission_adj
    from
        (select 
            gc.country_id as country,
            oa.order_platform,
            concat(s.id, ' - ', s.name) as store,
            count(distinct os.order_id) as orders,
            coalesce(sum(os.total_receipt),0) as merchant_payment,
            coalesce(sum(os.total_cart),0) as total_cart,
            coalesce(sum(os.delivery_charged) filter (where oa.with_subscription= false),0) as sh_paid,
            (count(distinct os.user_id) filter (where oa.with_subscription= true))*99 as pop_subscriptions,
            coalesce(sum(os.partner_commission) ,0)as partner_commission,
            coalesce(sum(os.cornershop_bags),0)*3.9 as bags,
            coalesce(sum(os.total_cart),0)*0.03 as processing_fees,
            sum(coc.from_call_rate + coc.to_call_rate)*22.3 as replacement_calls,
            sum(osc.total_commission) as shopper_commission,
            sum(refunds.cash_refunds) as cash_refunds,
            sum(refunds.credits_refunds) as credits_refunds,
            sum(refunds.transfer_refunds) as transfer_refunds
        from orders_ordersummary os
            join orders_orderattributes oa using (order_id)
            join catalog_store s on s.id = oa.store_id 
            join geo_city gc on gc.id = os.city_id
            left join 
                (select 
                    distinct os.order_id,
                    coalesce(sum(total_commission),0) as total_commission
                from orders_ordersummary os
                    join orders_shopperscommission using (order_id)
                where 1=1
                    and os.actual_delivery_time >= {{desde}} - interval '1 day' 
                    and os.actual_delivery_time < {{hasta}} + interval '2 day'
                    and os.actual_delivery_time at time zone 'America/Mexico_City' >= {{desde}} 
                    and os.actual_delivery_time at time zone 'America/Mexico_City' < {{hasta}} + interval '1 day'
                    and os.country = 'MX'
                    and os.status = 'DELIVERED'
                    and os.order_kind = 'NORMAL'
                group by 1
                ) osc using (order_id)
                
            left join
                (select 
                    distinct os.order_id,
                    coalesce(sum(from_call_rate),0) as from_call_rate,
                    coalesce(sum(to_call_rate),0) as  to_call_rate
                from orders_ordersummary os
                    join calls_ordercalls using (order_id)
                where 1=1
                    and os.actual_delivery_time >= {{desde}} - interval '1 day' 
                    and os.actual_delivery_time < {{hasta}} + interval '2 day'
                    and os.actual_delivery_time at time zone 'America/Mexico_City' >= {{desde}} 
                    and os.actual_delivery_time at time zone 'America/Mexico_City' < {{hasta}} + interval '1 day'
                    and os.country = 'MX'
                    and os.status = 'DELIVERED'
                    and os.order_kind = 'NORMAL'
                group by 1
                ) coc using (order_id)
                
            left join
                (select 
                    distinct os.order_id,
                    coalesce(sum(amount) filter (where type='cash' and description<>'Automatic Refund'),0) as cash_refunds,
                    coalesce(sum(amount) filter (where type='credits' and description<>'Automatic Refund'),0) as credits_refunds,
                    coalesce(sum(amount) filter (where type='transfer' and description<>'Automatic Refund'),0) as transfer_refunds
                from orders_ordersummary os
                    join customerservice_refunds using (order_id)
                where 1=1
                    and os.actual_delivery_time >= {{desde}} - interval '1 day' 
                    and os.actual_delivery_time < {{hasta}} + interval '2 day'
                    and os.actual_delivery_time at time zone 'America/Mexico_City' >= {{desde}} 
                    and os.actual_delivery_time at time zone 'America/Mexico_City' < {{hasta}} + interval '1 day'
                    and os.country = 'MX'
                    and os.status = 'DELIVERED'
                    and os.order_kind = 'NORMAL'
                group by 1
                ) refunds using (order_id)
            
        where 1=1
            [[and s.id in ({{store_id}})]]
            and os.actual_delivery_time >= {{desde}} - interval '1 day' 
            and os.actual_delivery_time < {{hasta}} + interval '2 day'
            and os.actual_delivery_time at time zone 'America/Mexico_City' >= {{desde}} 
            and os.actual_delivery_time at time zone 'America/Mexico_City' < {{hasta}} + interval '1 day'
            and os.country = 'MX'
            and os.status = 'DELIVERED'
            and os.order_kind = 'NORMAL'
        group by 1,2,3
        ) a
            
        left join 
            (select 
                oa.order_platform,
                concat(s.id, ' - ', s.name) as store,
                coalesce(sum(total_receipt),0) as ad_revenue_cost
            from public.orders_ordersummary os
                join public.orders_orderattributes oa using (order_id)
                join catalog_store s on s.id = oa.store_id 
            where 1=1
                [[and s.id in ({{store_id}})]]
                and os.order_kind = 'GIFT_ORDER'
                and os.country = 'MX'
                and os.actual_delivery_time >= {{desde}} - interval '1 day' 
                and os.actual_delivery_time < {{hasta}} + interval '2 day'
                and os.actual_delivery_time at time zone 'America/Mexico_City' >= {{desde}} 
                and os.actual_delivery_time at time zone 'America/Mexico_City' < {{hasta}} + interval '1 day'
            group by 1,2
            ) b using (order_platform, store)
            
        left join
            (select 
                oa.order_platform,
                concat(s.id, ' - ', s.name) as store,
                coalesce(sum(total_receipt),0) as post_sale_refunds
            from public.orders_ordersummary os
                join public.orders_orderattributes oa using (order_id)
                join catalog_store s on s.id = oa.store_id 
            where 1=1
                [[and s.id in ({{store_id}})]]
                and os.order_kind = 'POST_SALE'
                and os.country = 'MX'
                and os.actual_delivery_time >= {{desde}} - interval '1 day' 
                and os.actual_delivery_time < {{hasta}} + interval '2 day'
                and os.actual_delivery_time at time zone 'America/Mexico_City' >= {{desde}} 
                and os.actual_delivery_time at time zone 'America/Mexico_City' < {{hasta}} + interval '1 day'
            group by 1,2
            ) c using (order_platform, store)
                
        join 
            (select 
                country,
                coalesce(sum(amount),0) as shopper_extra_commission_total
            from commissions_othercommissions
            where 1=1
                and payment_date >= {{desde}} - interval '1 day' 
                and payment_date < {{hasta}} + interval '2 day'
                and payment_date at time zone 'America/Mexico_City' >= {{desde}} 
                and payment_date at time zone 'America/Mexico_City' < {{hasta}} + interval '1 day'
                and country = 'MX'
            group by 1
            ) d using (country)
    ) e;
