select
    to_char(o.actual_delivery_time at time zone sb.timezone, 'YYYY-MM') as year_month,
    members.loyalty_plan_name,
    count(distinct members.user_uuid) filter (where date_trunc('month', members.created_at)=date_trunc('month', o.actual_delivery_time)) as new_memberships,
    count(distinct o.id) as orders,
    sum(o.total_receipt) as sales,
    count(distinct o.user_id) as users,
    sum(o.qty_products_found) as qty_found,
    sum(o.qty_products_ordered) as qty_ordered,
    sum(o.qty_products_replaced) as qty_replaced
from 
    (select 
        p.name as loyalty_plan_name,
        m.user_uuid,
        m.created_at,
        row_number() over (partition by m.user_uuid,p.name order by m.created_at) as n
    from loyalty_planmembership m
        join loyalty_plan p on p.uuid = m.plan_uuid
    where p.name = 'Monedero Naranja'
    ) members
    
    join orders_order o on o.user_uuid = members.user_uuid
    join catalog_storebranch sb on sb.id = o.store_branch_id
where 1=1
    and sb.store_id in (9, 45, 1423, 1424)
    and members.n = 1
    and o.actual_delivery_time > members.created_at
    and o.actual_delivery_time >= date_trunc('month',current_date) - interval '8 month 1 day'
    and o.actual_delivery_time < date_trunc('month',current_date) + interval '1 day'
    and o.actual_delivery_time at time zone sb.timezone >= date_trunc('month',current_date) - interval '8 month'
    and o.actual_delivery_time at time zone sb.timezone < date_trunc('month',current_date)
    and o.order_kind = 'NORMAL'
    and o.status = 'DELIVERED'
group by 1,2
order by loyalty_plan_name, year_month;
