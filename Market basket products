select
    product_id,
    concat(p.name, ' ', p.package) as product,
    concat(b.id, '|', b.name) as brand,
    concat(c.id, '|', c.name) as category,
    orders
from
    (select
        p.id as product_id,
        count(distinct o.id) as orders
    from 
        (select
            o.id as order_id,
            p.id as product_id
        from orders_orderproduct op 
            join catalog_product p on p.id = op.product_id [[and p.id in ({{product_id_id}})]]
            join catalog_category c on c.id = p.category_id [[and c.id in ({{category_id}})]]
            join orders_order o on  o.id = op.order_id
            join catalog_storebranch sb on sb.id = o.store_branch_id
            join catalog_store s on s.id = sb.store_id [[and s.id in ({{store_id}})]]
            join geo_city gc on gc.id = sb.city_id
        where 1=1
            and o.actual_delivery_time >= {{date_from}} - interval '1 day' 
            and o.actual_delivery_time < {{date_to}} + interval '2 day'
            and o.actual_delivery_time at time zone gc.timezone >= {{date_from}} 
            and o.actual_delivery_time at time zone gc.timezone < {{date_to}} + interval '1 day'
            and o.currency = 'MXN'
            and o.status = 'DELIVERED'
            and o.order_kind = 'NORMAL'
        ) owp
        
        join orders_order o on o.id = owp.order_id
        join catalog_storebranch sb on sb.id = o.store_branch_id
        join catalog_store s on s.id = sb.store_id
        join geo_city gc on gc.id = sb.city_id
        join orders_orderproduct op on op.order_id = o.id
        join catalog_product p on p.id = op.product_id
    where 1=1
        [[and s.id in ({{store_id}})]]
        and o.actual_delivery_time >= {{date_from}} - interval '1 day' 
        and o.actual_delivery_time < {{date_to}} + interval '2 day'
        and o.actual_delivery_time at time zone gc.timezone >= {{date_from}} 
        and o.actual_delivery_time at time zone gc.timezone < {{date_to}} + interval '1 day'
        and o.currency = 'MXN'
        and o.status = 'DELIVERED'
        and o.order_kind = 'NORMAL'
        and p.id <> owp.product_id
    group by 1
    ) a
    
    join catalog_product p on p.id = a.product_id
    join catalog_category c on c.id = p.category_id
    left join catalog_brand b on b.id = p.brand_id
order by orders desc
limit 50;
