with aux as(
    select
        sd.user_id,
        sc.product_id as product_id,
        cp.name as product_name,
        count(distinct sd.order_id) as total_samplings
    from orders_order o
        join sampling_samplingdelivery sd on sd.order_id = o.id
        join sampling_samplingcampaign sc on sc.id = sd.campaign_id and sc.id in ({{sampling_campaign}})
        join catalog_product cp on cp.id = sc.product_id
    where 1=1
        and sd.quantity_delivered > 0
        and sd.status = 'DELIVERED'
        and o.status = 'DELIVERED'
        and o.order_kind = 'NORMAL'
        and o.actual_delivery_time >= {{desde}} - interval '1 day'
        and o.actual_delivery_time < {{hasta}} + interval '2 day'
    group by 1,2,3)

select product_id, product_name, total_samplings, count(distinct user_id) as users from aux group by 1,2,3;
