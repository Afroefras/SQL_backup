select 
    concat(sb.id, '|', sb.name) as branch,
    date_trunc('day', o.actual_delivery_time at time zone gc.timezone) as order_date,
    o.id as order_id, 
    o.external_id,
    o.user_id,
    op.quantity,
    op.quantity_found,
    op.custom_request
from orders_order o
    join crm_users_view u on u.id = o.user_id
    join catalog_storebranch sb on sb.id = o.store_branch_id
    join geo_city gc on gc.id = sb.city_id
    join orders_orderproduct op on op.order_id = o.id and op.product_id = 196313
where 1=1
    and sb.id in (1490,32493)
    and o.actual_delivery_time >= {{date_from}} - interval '1 day' 
    and o.actual_delivery_time < {{date_to}} + interval '2 day'
    and o.actual_delivery_time at time zone gc.timezone >= {{date_from}} 
    and o.actual_delivery_time at time zone gc.timezone < {{date_to}} + interval '1 day'
    and o.currency = 'MXN'
    and o.order_kind = 'NORMAL'
    and o.status = 'DELIVERED'
;
