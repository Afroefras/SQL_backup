with target_users as (
    select 
        o.user_id,
        min(o.actual_delivery_time at time zone gc.timezone) as first_order_date
    from orders_order o
        join catalog_storebranch sb on sb.id = o.store_branch_id
        join geo_city gc on gc.id = sb.city_id
        join catalog_store s on s.id = sb.store_id and s.id = {{store_id}}
    where 1=1
        and o.actual_delivery_time >= {{date_from}} - interval '1 year 1 day' 
        and o.actual_delivery_time < {{date_to}} + interval '2 day'
        and o.actual_delivery_time at time zone gc.timezone >= {{date_from}} - interval '1 year'
        and o.actual_delivery_time at time zone gc.timezone < {{date_to}} + interval '1 day'
        and o.currency = 'MXN'
        and o.order_kind = 'NORMAL'
        and o.status = 'DELIVERED'
        and s.status = 'ACTIVE'
    group by 1
    ),
    
    retention_users as (
    select 
        distinct tu.user_id
    from target_users tu
        join orders_order o using (user_id) 
        join catalog_storebranch sb on sb.id = o.store_branch_id
        join geo_city gc on gc.id = sb.city_id
        join catalog_store s on s.id = sb.store_id and s.id = {{store_id}}
    where 1=1
        and o.actual_delivery_time >= {{date_from}} - interval '1 day'
        and o.actual_delivery_time at time zone gc.timezone >= {{date_from}}
        and o.actual_delivery_time > tu.first_order_date - interval '1 day'
        and o.actual_delivery_time at time zone gc.timezone > tu.first_order_date
    )

select 
    date_trunc('month', tu.first_order_date) as order_month,
    count(distinct tu.user_id) as new_users,
    count(distinct ru.user_id) as retention_users
from target_users tu
    left join retention_users ru using (user_id)
where tu.first_order_date >= {{date_from}}
group by 1;
