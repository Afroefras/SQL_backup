select
    date_trunc('month', o.actual_delivery_time at time zone sb.timezone) as year_month,
    members.loyalty_plan_name,s.name as store,
    count(distinct members.user_uuid) filter (where date_trunc('month', members.created_at)=date_trunc('month', o.actual_delivery_time)) as new_memberships,
    count(distinct o.id) as orders,
    sum(o.total_receipt) as sales,
    count(distinct o.user_id) as users,
    sum(o.qty_products_found) as qty_found,
    sum(o.qty_products_ordered) as qty_ordered,
    sum(o.qty_products_replaced) as qty_replaced
from 
    (select 
        p.name as loyalty_plan_name,
        m.user_uuid,
        m.created_at,
        row_number() over (partition by m.user_uuid order by m.created_at) as n
    from loyalty_planmembership m
        join loyalty_plan p on p.uuid = m.plan_uuid
    where p.uuid = '38d82ad3-e9fb-4857-bbc7-72ffb327af4a'
    ) members
    
    join orders_order o on o.user_uuid = members.user_uuid
    join catalog_storebranch sb on sb.id = o.store_branch_id
    join catalog_store s on s.id = sb.store_id
where 1=1
    and members.n = 1
    and s.id in (9, 45, 1423, 1424)
    and o.actual_delivery_time > members.created_at
    and o.actual_delivery_time >= date_trunc('month',current_date) - interval '1 month 1 day'
    and o.actual_delivery_time < date_trunc('month',current_date)
    and o.actual_delivery_time at time zone sb.timezone >= date_trunc('month',current_date) - interval '1 month'
    and o.actual_delivery_time at time zone sb.timezone < date_trunc('month',current_date)
    and o.order_kind = 'NORMAL'
    and o.status = 'DELIVERED'
group by 1,2,3;
