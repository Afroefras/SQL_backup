select
    b.name as brand_name,
    count(distinct o.id) as orders,
    count(distinct o.user_id) as users,
    count(distinct o.id)*1.00 / count(distinct o.user_id) as orders_p_user
from orders_orderproduct op
    join orders_order o on o.id = op.order_id and o.currency='MXN' and o.actual_delivery_time between {{desde}} - interval '1 day' and {{hasta}} + interval '1 day' and o.status= 'DELIVERED' and o.order_kind = 'NORMAL'
    join catalog_product p on p.id = op.product_id and p.brand_id in ({{brands}})
    join catalog_brand b on b.id = p.brand_id
group by 1
order by 4 desc;
