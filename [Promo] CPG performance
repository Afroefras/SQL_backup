with target_orders as (
    select
        distinct o.id as order_id,
        o.user_id,
        concat(cpg.id, ' - ', cpg.name) as cpg,
        concat(pp.id, ' - ', pp.name) as project,
        pp.initial_budget, 
        oc.budget_used as budget_used
    from promotions_ordercampaign oc
        join promotions_campaign pc on pc.id = oc.campaign_id
        join promotions_promotionalprojectcomponent ppc on ppc.component_id = pc.id
        join promotions_promotionalproject pp on pp.id = ppc.promotional_project_id
        join brandcenter_brandcentercpg cpg on cpg.id = pc.cpg_id
        join orders_order o on o.id = oc.order_id
        join catalog_storebranch sb on o.shopper_store_branch_id = sb.id
    where 1=1
        [[and pp.id in ({{project_id}})]]
        [[and pc.id in ({{campaign_id}})]]
        and ppc.component_content_type_id <> 243
        [[and cpg.id in ({{cpg_id}})]]
        [[and o.actual_delivery_time >= {{from}} - interval '1 day']]
        [[and o.actual_delivery_time < {{until}} + interval '2 day']]
        [[and o.actual_delivery_time at time zone sb.timezone >= {{from}}]]
        [[and o.actual_delivery_time at time zone sb.timezone < {{until}} + interval '1 day']]
        and o.currency = 'MXN'
        and o.status = 'DELIVERED'
    )
   
select *, 
    found*100.00/ordered as found_rate,
    sales*1.00/orders as avg_ticket
from
    (select 
        tor.cpg,
        tor.project,
        tor.initial_budget,
        sum(tor.budget_used) as budget_used,
        count(distinct tor.order_id) as orders,
        count(distinct tor.user_id) as users,
        sum(cp.ordered) as ordered,
        sum(cp.found) as found,
        sum(cp.sales) as sales
    from target_orders tor
        join 
            (select 
                op.order_id,
                sum(op.quantity) as ordered,
                sum(op.quantity_found) as found,
                sum(coalesce(op.quantity_found*op.branch_price,0)) as sales
            from orders_orderproduct op
                join catalog_product p on p.id = op.product_id
                join catalog_brand b on b.id = p.brand_id
                join brandcenter_brandcentercpg_brands bcpg on bcpg.brand_id = b.id 
                join brandcenter_brandcentercpg cpg on cpg.id = bcpg.brandcentercpg_id
                join orders_order o on o.id = op.order_id
            where 1=1
                [[and o.actual_delivery_time >= {{from}} - interval '1 day']]
                [[and o.actual_delivery_time < {{until}} + interval '2 day']]
                [[and o.actual_delivery_time at time zone sb.timezone >= {{from}}]]
                [[and o.actual_delivery_time at time zone sb.timezone < {{until}} + interval '1 day']]
                and o.id in (select order_id from target_orders)
                [[and cpg.id in ({{cpg_id}})]]
            group by 1
            ) cp on cp.order_id = tor.order_id
    group by 1,2,3
    ) a
order by cpg, orders desc;
