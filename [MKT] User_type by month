select *,
    total_orders > 20 as more_than_20_orders,
    case when nongroceries_orders=0 and groceries_orders=0 and selfservice_orders>0 then 'Non-Groceries only'
        when nongroceries_orders=0 and groceries_orders>0  and selfservice_orders=0 then 'Supermercados only'
        when nongroceries_orders>0 and groceries_orders=0  and selfservice_orders=0 then 'Express only'
        when nongroceries_orders>0 and groceries_orders>0  and selfservice_orders>0 then 'Bought all'
        when nongroceries_orders>0 and groceries_orders>0  and selfservice_orders=0 then 'Super + Express'
        when nongroceries_orders=0 and groceries_orders>0  and selfservice_orders>0 then 'Super + Non-Groceries'
        when nongroceries_orders>0 and groceries_orders=0  and selfservice_orders>0 then 'Express + Non-Groceries'
        else 'what?' end as user_type
from
    (select
        to_char(order_month, 'YYYY-MM') as month,
        u.id as user_id,
        case when date_trunc('month', coalesce(u.date_first_order, u.created)) = order_month then 1 else 0 end as is_new_user,
        count(distinct order_id) as total_orders,
        count(distinct order_id) filter (where order_pop) as pop_orders,
        count(distinct order_id) filter (where order_platform = 'Uber') as uber_orders,
        count(distinct order_id) filter (where store_type = 'Non-Groceries') as nongroceries_orders,
        count(distinct order_id) filter (where store_type = 'Groceries') as groceries_orders,
        count(distinct order_id) filter (where store_type = 'Self-service') as selfservice_orders,
        coalesce(sum(merchant_payment) filter (where store_type = 'Non-Groceries'), 0) as nongroceries_gmv,
        coalesce(sum(merchant_payment) filter (where store_type = 'Groceries'), 0) as groceries_gmv,
        coalesce(sum(merchant_payment) filter (where store_type = 'Self-service'), 0) as selfservice_gmv
    from
        (select
            distinct o.id as order_id,
            date_trunc('month', o.actual_delivery_time at time zone sb.timezone) as order_month,
            o.user_id,
            o.total_receipt as merchant_payment,
            o.with_subscription as order_pop,
            case when o.platform = 0 and (o.client_bundle like '%uber%' or (o.client_bundle is null and u.tmp_uber_original_segmentation = 'Uber')) then 'Uber' else 'Cornershop' end as order_platform,
            case when s.id in (2902,2648, 2712) then 'Convenience'
                when sc.id <> 13 and not s.is_longtail then 'Non-Groceries'
                when sc.id = 13 and not s.is_longtail then 'Groceries' else 'Self-service' end as store_type
        from orders_order o
            join crm_users_view u on u.id = o.user_id
            join catalog_storebranch sb on sb.id = o.store_branch_id
            join catalog_store s on s.id = sb.store_id
            left join catalog_storecollectionitem sci on sci.store_id = s.id
            left join catalog_storecollection sc on sc.id = sci.collection_id
        where 1=1
            and o.actual_delivery_time >= {{desde}} - interval '2 day'
            and o.actual_delivery_time < {{hasta}} + interval '2 day'
            and o.actual_delivery_time at time zone sb.timezone >= {{desde}}
            and o.actual_delivery_time at time zone sb.timezone < {{hasta}} + interval '1 day'
            and o.currency = 'MXN'
            and o.order_kind = 'NORMAL'
            and o.status = 'DELIVERED'
            and s.country = 'MX'
            and s.status = 'ACTIVE'
        ) a 
        join crm_users_view u on u.id = a.user_id
    group by 1,2,3,4
    ) b;
