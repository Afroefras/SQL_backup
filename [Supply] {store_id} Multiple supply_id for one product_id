with multimapped as 
    (select
        sp.catalog_product_id
    from supply_product sp 
        join supply_productbranch spb on sp.id = spb.product_id
        join supply_storebranch ssb on ssb.id = spb.store_branch_id
    where 1=1
        and ssb.store_id = {{store_id}}
        and sp.catalog_product_id is not null
    group by 1 
    having count(distinct sp.id) > 1
    )

select 
    sp.id as supply_id,
    sp.catalog_product_id,
    max(spb.last_visited) as max_last_visited
from supply_product sp
    join supply_productbranch spb on sp.id = spb.product_id 
    join supply_storebranch ssb on ssb.id = spb.store_branch_id
where 
    exists (select 1 from multimapped m where sp.catalog_product_id = m.catalog_product_id) and 
    ssb.store_id = {{store_id}}
group by 1,2
order by 2;
