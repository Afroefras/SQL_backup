with multimapped as 
    (select
        sp.sku_source,
        sp.catalog_product_id
    from supply_product sp 
    join supply_productbranch spb on sp.id = spb.product_id 
    where 
        sp.sku_source in ('br-nacional-csv','br-bigbompreco-csv','br-bompreco-csv','br-superbompreco-csv') and 
        sp.catalog_product_id is not null
    group by 1,2
    having count(distinct sp.id) > 1
    )

select 
    sp.id as supply_id,
    sp.sku_source,
    sp.catalog_product_id,
    max(spb.last_visited) as max_last_visited
from supply_product sp 
    join supply_productbranch spb on sp.id = spb.product_id 
where
    exists (select 1 from multimapped m where sp.catalog_product_id = m.catalog_product_id and m.sku_source = sp.sku_source)
    and sp.sku_source in ('br-nacional-csv','br-bigbompreco-csv','br-bompreco-csv','br-superbompreco-csv')
group by 1,2,3
order by 2,3;
