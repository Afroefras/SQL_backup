with sampling_zone as(
    select
        gc.name as city,
        goz.id as zone_id,
        goz.name as zone,
        sc.id as campaign_id,
        sd.user_id,
        sc.product_id as product_id,
        cp.name as product_name,
        count(distinct sd.order_id) as total_samplings
    from orders_order o
        join sampling_samplingdelivery sd on sd.order_id = o.id
        join sampling_samplingcampaign sc on sc.id = sd.campaign_id
        join catalog_product cp on cp.id = sc.product_id
        join catalog_storebranch sb on sb.id = o.store_branch_id
        join geo_city gc on gc.id = sb.city_id
        join geo_opzone goz on ST_Intersects(goz.multi_poly, sb.picking_point) and not goz.deleted
    where 1=1
        [[and sc.id in ({{sampling_campaign}})]]
        and sd.quantity_delivered > 0
        and sd.status = 'DELIVERED'
        and gc.country_id = 'MX'
        and o.status = 'DELIVERED'
        and o.order_kind = 'NORMAL'
        [[and o.actual_delivery_time >= {{desde}} - interval '1 day']]
        [[and o.actual_delivery_time < {{hasta}} + interval '2 day']]
    group by 1,2,3,4,5,6,7
    )

select 
    sz.city,
    sz.zone,
    concat('_',LPAD(sz.total_samplings::text, 2, '0')) as total_samplings,
    count(distinct sz.user_id) as sampling_users,
    count(distinct sz.campaign_id) as sampling_campaigns,
    avg(tot.total_users) as total_users,
    count(distinct sz.user_id)*1.00 / avg(tot.total_users) as sampled_from_tot
from sampling_zone sz 
    join 
        (select
            goz.id as zone_id,
            count(distinct o.user_id) as total_users
        from orders_order o
            join catalog_storebranch sb on sb.id = o.store_branch_id
            join geo_city gc on gc.id = sb.city_id
            join geo_opzone goz on ST_Intersects(goz.multi_poly, sb.picking_point) and not goz.deleted
        where 1=1
            and gc.country_id = 'MX'
            and o.status = 'DELIVERED'
            and o.order_kind = 'NORMAL'
            [[and o.actual_delivery_time >= {{desde}} - interval '1 day']]
            [[and o.actual_delivery_time < {{hasta}} + interval '2 day']]
        group by 1
        ) tot on tot.zone_id = sz.zone_id
        
group by 1,2,3
order by sampled_from_tot desc;
