with branches as (
    select distinct branch
    from catalog_supply.temporary_supply_data sd
    where sd.store_id = {{store_id}}
)
select 
    status_info,
    purchasable,
    mapped,
    stock_,
    integration_action,
    count(*) as productbranches,
    count(distinct product_id) as products,
    count(*) filter (where times_ordered > 0)*100::numeric / count(*) as pb_ordered,
    count(*) filter (where times_ordered > 0 and times_found > 0)*100::numeric / count(*) as pb_found,
    sum(times_found)*100::numeric / sum(times_ordered) as found_rate,
    sum(times_ordered) as times_ordered,
    sum(times_found) as times_found,
    sum(times_replaced_list) as list_replacement,
    sum(times_replaced_custom) as custom_replacement
from (
    select
        cd.*,
        case
            when cd.status is null and sd.catalog_product_id is not null then 'No ProductBranch'
            when cd.status is null and sd.catalog_product_id is null then 'Unmapped'
            else cd.status
            end as status_info,
        case
            when (cd.availability_status in ('AVAILABLE') or cd.availability_status is null) and cd.product_id is not null then 'True (Available)'
            when (cd.availability_status in ('FREQUENTLY_OUT_OF_STOCK')) and cd.product_id is not null then 'True (FOOS)'
            when cd.availability_status in ('OUT_OF_STOCK') then 'False (OOS)'
            when cd.availability_status is null and sd.catalog_product_id is null then 'False (Unmapped)'
            when cd.availability_status is null and sd.catalog_product_id is not null then 'False (No ProductBranch)'
            else 'False (Other)'
            end as purchasable,
            
        case 
            when /*sd.catalog_product_id is not null and */max(sd.min_last_visit) > {{last_visited}} then 'True'
            when /*sd.catalog_product_id is not null and*/ max(sd.min_last_visit) <= {{last_visited}} then 'False (stop send)'
            when max(sd.min_last_visit) is null then 'False (unmapped)'
            else 'Unknown'
            end as mapped,
            
        case 
            when sum(coalesce(sd.stock, 0)) > 0 then 'True'
            when sum(sd.stock) = 0 and count(*) filter (where sd.stock is not null) <> 0 then 'False'
            else 'No Info'
            end as stock_,
        
        /*case
            when sum(coalesce(sd.stock, 0)) > 0 then 'AV'
            --when sum(coalesce(sd.stock, 0)) < 5  then 'FOOS'
            when sum(coalesce(sd.stock, 0)) <= 0 then 'OOS'
            when sum(coalesce(sd.stock, 0)) < 0 then 'Negative'
            else 'No Info'
            end as stock_label*/
            
        case 
            when max(sd.min_last_visit) is null then 'UNMAPPED'
            when max(sd.min_last_visit) <= {{last_visited}} then 'STOP SEND'
            when sum(coalesce(sd.stock, 0)) > 0 then 'AVAILABLE'
            --when sum(coalesce(sd.stock, 0)) > 0 then 'FOOS'
            when sum(coalesce(sd.stock, 0)) <= 0 then 'OOS'
            end as integration_action
        
    from catalog_supply.temporary_catalog_data cd
    full outer join catalog_supply.temporary_supply_data sd on cd.product_id = sd.catalog_product_id and sd.branch = cd.branch_id
    where cd.store_id = {{store_id}} and cd.branch_id in (select * from branches)
    group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28
    ) j
group by 1,2,3,4,5
UNION ALL
select 
    status_info,
    purchasable,
    mapped, 
    stock_,
    integration_action,
    count(*) as productbranches,
    count(distinct supply_product_id) as products,
    null as pb_ordered,
    null as pb_found,
    null as found_rate,
    null as times_ordered,
    null,
    null,
    null
from (
    select
        sd.*,
        case
            when cd.status is null and sd.catalog_product_id is not null then 'No ProductBranch'
            when cd.status is null and sd.catalog_product_id is null then 'Unmapped'
            else cd.status
            end as status_info,
        case
            when cd.parent_category in ('Frutas y verduras', 'LÃ¡cteos y huevos', 'Carnes, aves y peces') then 'ALWAYS AVAILABLE'
            when (cd.availability_status in ('AVAILABLE') or cd.availability_status is null) and cd.product_id is not null then 'True (Available)'
            when (cd.availability_status in ('FREQUENTLY_OUT_OF_STOCK')) and cd.product_id is not null then 'True (FOOS)'
            when cd.availability_status in ('OUT_OF_STOCK') then 'False (OOS)'
            when cd.availability_status is null and sd.catalog_product_id is null then 'False (Unmapped)'
            when cd.availability_status is null and sd.catalog_product_id is not null then 'False (No ProductBranch)'
            else 'False (Other)'
            end as purchasable,
            
        case 
            when /*sd.catalog_product_id is not null and*/ max(sd.min_last_visit) > {{last_visited}} then 'True'
            when /*sd.catalog_product_id is not null and*/ max(sd.min_last_visit) <= {{last_visited}} then 'False (stop send)'
            when max(sd.min_last_visit) is null then 'False (unmapped)'
            else 'True'
            end as mapped,
            
        case 
            when sum(coalesce(sd.stock, 0)) > 0 then 'True'
            when sum(coalesce(sd.stock, 0)) = 0 and count(*) filter (where sd.stock is not null) <> 0 then 'False'
            else 'No Info'
            end as stock_,
            
        /*case
            when sum(coalesce(sd.stock, 0)) > 0 then 'AV'
            --when sum(coalesce(sd.stock, 0)) < 5  then 'FOOS'
            when sum(coalesce(sd.stock, 0)) <= 0 then 'OOS'
            when sum(coalesce(sd.stock, 0)) < 0 then 'Negative'
            else 'No Info'
            end as stock_label*/
            
        case 
            when max(sd.min_last_visit) is null then 'UNMAPPED'
            when max(sd.min_last_visit) <= {{last_visited}} then 'STOP SEND'
            when sum(coalesce(sd.stock, 0)) > 0 then 'AVAILABLE'
            --when sum(coalesce(sd.stock, 0)) > 0 then 'FOOS'
            when sum(coalesce(sd.stock, 0)) <= 0 then 'OOS'
            end as integration_action
        
    from catalog_supply.temporary_catalog_data cd
    full outer join catalog_supply.temporary_supply_data sd on cd.product_id = sd.catalog_product_id and sd.branch = cd.branch_id
    where sd.store_id = {{store_id}} and sd.catalog_product_id is null and sd.branch in (select * from branches)
    group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
    ) j
group by 1,2,3,4,5
order by times_ordered desc nulls last;
