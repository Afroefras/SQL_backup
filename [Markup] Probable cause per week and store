--BIG: 1481 one week
--Prezunic: 4878 two weeks
--Atacad√£o: 3101
--Carrefour Hiper: 1327
--Carrefour Bairro: 5048 one month
--Carrefour Pamplona: 4100 one month
--Carrefour Drogaria: 6974 one month

select 
    j.week,
    j.store_id,
    j.store,
    j.probable_cause,
    j.markup_kind,
    count(j.order_id) as orders,
    sum(j.total_receipt) as total_receipt,
    --sum(j.markup)*100.00/sum(j.total_receipt) as markup_pctg,
    sum(j.markup) as total_markup
from
    (select 
        to_char(i.date,'IYYY-IW') as week,
        date_trunc('day',i.date) as delivery_date,
        i.country,
        i.id store_id,
        i.store,
        i.city,
        i.branch_name,
        i.order_id,
        i.external_id,
        --i.user_id,
        i.consolidated_order,
        i.same_branch as picking_customer_branch,
        i.same_day,
        --i.image_url,
        i.with_store_promo,
        case 
            when abs(sum(i.products_charged -i.receipt_after_taxes)::numeric / greatest(sum(i.receipt_after_taxes), 1))::numeric < {{tolerance}} then 'No Markup'
            when sum(i.products_charged -i.receipt_after_taxes)::numeric < 0 and abs(sum(i.products_charged -i.receipt_after_taxes)::numeric) between 0.7*sum(i.store_discount) and 1.3*sum(i.store_discount) then 'Promo not reflected in store'
            when sum(i.qty_receipts) >1 and abs(round((sum(i.products_charged - i.receipt_after_taxes)::numeric / greatest(sum(i.receipt_after_taxes), 1))::numeric, 2)) between 0.47 and 0.53 then 'Duplicated Receipt'
            when sum(i.qty_receipts) >1 and abs(round((sum(i.products_charged - i.receipt_after_taxes)::numeric / greatest(sum(i.receipt_after_taxes), 1))::numeric, 2)) > 0.25 then 'Multiple Receipt'
            when i.same_branch = false and abs(round((sum(i.products_charged - i.receipt_after_taxes)::numeric / greatest(sum(i.receipt_after_taxes), 1))::numeric, 2)) between 0.9 and 1.1 then 'Different branch'
            when sum(i.products_charged - i.receipt_after_taxes)::numeric > 0 and sum(markup_branch_price)::numeric /sum(i.products_charged -i.receipt_after_taxes)::numeric between 0.01 and 0.3 then 'Promo not reflected in app'
            when sum(i.products_charged - i.receipt_after_taxes)::numeric != 0 and sum(markup_branch_price) = 0 then 'Different price not declared by shopper'
            else 'Different Price/Product' end as probable_cause,
        case 
            when (sum(i.products_charged - i.receipt_after_taxes)::numeric / greatest(sum(i.receipt_after_taxes), 1))::numeric<-{{tolerance}} then 'Markdown'
            when (sum(i.products_charged - i.receipt_after_taxes)::numeric / greatest(sum(i.receipt_after_taxes), 1))::numeric>{{tolerance}} then 'Markup'
            else 'No markup' end as markup_kind,
        sum(i.total) as total_charged,
        sum(i.delivery_charged) delivery_charged,
        sum(i.service_fee) as service_fee_charged,
        sum(i.cpg_discount) cpg_discount,
        avg(i.markup_pctg) store_markup_pctg,
        sum(i.products_charged) products_charged,
        --sum(i.taxes) taxes,
        --sum(i.products_charged)-sum(taxes) as products_charged_without_taxes,
        sum(i.receipt_after_taxes) as total_receipt,
        round((sum(i.products_charged -i.receipt_after_taxes))::numeric, 2) as markup, 
        round((sum(i.products_charged -i.receipt_after_taxes)*100::numeric / greatest(sum(i.receipt_after_taxes), 1))::numeric, 2) as markup_pctg,
        sum(i.store_discount) store_discount,
        round(sum(markup_cornershop_price)::numeric, 2) markup_customer_price,
        round(sum(markup_branch_price)::numeric, 2) markup_branch_price
    from 
        (select 
            o.actual_delivery_time at time zone csb.timezone as date,     
            cs.country,
            cs.id, 
            cs.name as store,
            gc.name as city,
            csb.id as branch_id, 
            csb.name as branch_name,
            o.id as order_id,
            o.external_id,
            o.user_id,
            case when o.created::date = o.actual_delivery_time::date then true else false end same_day,
            case when o.total_receipt is not null then true else false end consolidated_order,
            case when o.shopper_store_branch_id = o.store_branch_id then true else false end same_branch,
            o.delivery_charged,
            csb.markup_pctg,
            o.total, 
            och_t.price_charged as taxes, 
            och_m.price_charged as service_fee, 
            coalesce(d.discount, 0) as cpg_discount, 
            (o.total - o.delivery_charged - coalesce(och_m.price_charged, 0) + coalesce(d.discount, 0))/(1 + coalesce(csb.markup_pctg, 0)/100) as products_charged, 
            coalesce(sd.discount,0) as store_discount,
            coalesce(cat_info.markup_cornershop_price,0) as markup_cornershop_price,
            coalesce(cat_info.markup_branch_price,0) as markup_branch_price,
            case 
                when cs.country in ('CA', 'US') then sum(coalesce(cg.value::numeric, fv.value::numeric, ror.shopper_total, 0)) 
                else coalesce(o.total_receipt, o.shopper_total_receipt)end as receipt_after_taxes,
            case when 
                exists
                    (select oc.order_id from promotions_campaign pc
                    join promotions_ordercampaign oc on pc.id = oc.campaign_id and o.id = oc.order_id
                    where pc.is_store_promotion and oc.discount > 0) then true else false end with_store_promo,
            --split_part(string_agg(ror.image_url,','),',',1) as image_url,
            count(ror.order_id) as qty_receipts
        from orders_order o 
            left join orders_chargeableitem och_t on o.id = och_t.order_id and och_t.type = 'TAXES'
            left join orders_chargeableitem och_m on o.id = och_m.order_id and och_m.type = 'MARKUP'
            join catalog_storebranch csb on o.shopper_store_branch_id = csb.id 
            join receipts_orderreceipt ror on o.id = ror.order_id and ror.valid
            left join consolidator_goal cg on ror.id = cg.target_id and cg.target_content_type_id = 120 and cg.check_type_id = 40 and cg.consolidated
            join catalog_store cs on csb.store_id = cs.id and cs.country = {{country}}
            join geo_city gc on gc.id=csb.city_id
            left join common_eventoperation ceo on ceo.reference_content_type_id = 25 and ceo.reference_id = o.id and ceo.operation_type = 'ORDER_SET_AS_FREE_OF_CHARGE'
            left join
                (select fv.receipt_id, fv.value
                from receipts_orderreceiptfieldvalue fv
                    join receipts_storereceiptfielddefinition fd on fv.field_definition_id = fd.id and fd.name = 'total_after_taxes') fv on ror.id = fv.receipt_id        
            left join 
                (select 
                    coalesce(sum(discount), 0) as discount, 
                    order_id
                from promotions_ordercampaign oc
                    join orders_order o on o.id=order_id 
                    join catalog_storebranch csb on o.shopper_store_branch_id = csb.id
            where 1=1
                and not exists
                    (select 1
                    from promotions_freedeliverycampaign fc
                    where campaign_ptr_id = oc.campaign_id
                    and not o.with_subscription
                    union select 1
                    from promotions_campaign pc
                    where pc.is_store_promotion and oc.campaign_id = pc.id)
                and o.actual_delivery_time between {{start_date}} - interval '1 day' and {{end_date}} + interval '2 day' 
                [[and csb.store_id = {{store_id}}]]
                group by order_id) d on o.id = d.order_id
                
        -- STORE DISCOUNTS
            left join 
                (select coalesce(sum(discount), 0) as discount, order_id
                from promotions_ordercampaign oc
                    join orders_order o ON o.id = order_id 
                    join catalog_storebranch csb on o.shopper_store_branch_id = csb.id
                where 1=1
                    and exists
                       (select 1
                        from promotions_campaign pc
                        where pc.is_store_promotion and oc.campaign_id = pc.id) 
                    and o.actual_delivery_time between {{start_date}} - interval '1 day' and {{end_date}} + interval '2 day' 
                    [[and csb.store_id = {{store_id}}]]
                group by order_id
                ) sd on o.id = sd.order_id 
        -- Catalog information markup
        left join 
                (select 
                    op.order_id,
                    sum(op.quantity_found*(op.cornershop_price/(1+csb.markup_pctg/100.00)-op.shopper_price)) markup_cornershop_price,--Se le quita el sobreprecio de la branch
                    sum(op.quantity_found*(op.branch_price-op.shopper_price)) markup_branch_price
                from orders_order o 
                    join orders_orderproduct op on op.order_id = o.id 
                    join catalog_storebranch csb on o.shopper_store_branch_id = csb.id and csb.store_id = {{store_id}}
                where 1=1
                    and o.actual_delivery_time between {{start_date}} - interval '1 day' and {{end_date}} + interval '2 day'
                    and o.status = 'DELIVERED' 
                    and o.order_kind = 'NORMAL'
                group by 1) cat_info on o.id = cat_info.order_id 
        where 1=1
            and o.actual_delivery_time between {{start_date}} - interval '1 day' and {{end_date}} + interval '2 day' 
            and o.status = 'DELIVERED' 
            and o.order_kind = 'NORMAL' 
            and ceo.reference_id is null
            [[and csb.store_id = {{store_id}}]] 
        group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23) i 
    where i.date between {{start_date}} and {{end_date}} + interval'1 day'
    group by 1,2,3,4,5,6,7,8,9,10,11,12,13
    order by 1) j
group by 1,2,3,4,5
order by total_markup;
