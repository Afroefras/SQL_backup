select *,
    sum(times_ordered) over (partition by 1 order by times_ordered desc)*100.00/ (sum(times_ordered) over ()) as cumsum
from 
    (select 
        c.name as category_id,
        count(distinct op.id) as times_ordered
    from orders_orderproduct op
        join orders_order o on o.id = op.order_id
        join catalog_storebranch sb on sb.id = o.store_branch_id
        join geo_city gc on gc.id = sb.city_id
        join catalog_store s on s.id = sb.store_id
        join catalog_product p on p.id = op.product_id
        join catalog_category c on c.id = p.category_id
    where 1=1
        and s.id in ({{store_id}})
        and o.actual_delivery_time >= current_date - interval '1 month 1 day' 
        and o.actual_delivery_time at time zone gc.timezone >= current_date - interval '1 month'
        and o.currency = 'MXN'
        and o.order_kind = 'NORMAL'
        and o.status = 'DELIVERED'
        and p.is_active
        and s.status = 'ACTIVE'
    group by 1
    ) a
order by cumsum;
