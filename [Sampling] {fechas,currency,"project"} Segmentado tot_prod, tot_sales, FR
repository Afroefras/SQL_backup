with gift_products as (
    select 
        pp.id as project_id,
        pp.name as project_name,
        pp.initial_budget,
        pp.available_budget,
        gpc.campaign_ptr_id,
        unnest(gpc.products_barcodes)::numeric as product_id
    from promotions_giftproductcampaign gpc
        join promotions_promotionalprojectcomponent ppc on ppc.component_id=gpc.campaign_ptr_id and ppc.component_content_type_id = 447
        join promotions_promotionalproject pp on pp.id = ppc.promotional_project_id 
    group by 1,2,3,4,5)

select  
    gp.project_id,
    gp.project_name,
    c.id as campaign_id,
    c.name as campaign_name,
    gp.initial_budget,
    gp.available_budget,
    p.id as product_id,
    p.name as product_name,
    (sum(spc.amount) / sum(o.qty_products_found)*sum(op.quantity_found))::numeric as shopper_commission,
    sum(op.branch_price*op.quantity_found) as total_sales,
    coalesce(sum(op.quantity_found),0) + sum(op.quantity) as total_products_delivered,
    coalesce(sum(op.quantity_found),0) / sum(op.quantity)::numeric  as foundrate
from gift_products gp
    join promotions_campaign c on c.id = gp.campaign_ptr_id
    join promotions_ordercampaign oc on oc.campaign_id = c.id 
    join orders_order o on o.id = oc.order_id
    join shoppers_shoppercommission spc on spc.reference_id = o.id
    join orders_orderproduct op on op.order_id = o.id and op.product_id = gp.product_id
    join catalog_product p on p.id = op.product_id
where 1=1
    [[and gp.project_id in ({{project_id}})]]
    and o.status = 'DELIVERED'
    and o.actual_delivery_time >= {{desde}} - interval '1 day'
    and o.actual_delivery_time < {{hasta}} + interval '2 day'
    and o.currency = {{currency}}
group by 1,2,3,4,5,6,7;
