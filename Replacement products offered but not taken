select 
    o.actual_delivery_time at time zone gc.timezone as order_date,
    o.id as order_id,
    o.shopper_store_branch_id as branch_id,
    op.product_id,
    op.quantity_found,
    ora.product_alternative_id,
    ora.name as alternative_product_name,
    op.replaced
from orders_order o
    join geo_city gc on gc.id = o.customer_city_id
    join orders_orderproduct op on o.id = op.order_id
    join orders_orderreplacementalternativeprocess orap on o.id = orap.order_id
    join orders_orderreplacementalternative ora on orap.id = ora.process_id and ora.requester = 'SHOPPER' and ora.ext_item_uuid = op.uuid
    join orders_orderreplacementalternativeselection oras on orap.id = oras.process_id 
where 1=1
    and o.shopper_store_branch_id in ({{branch_id}})
    and op.quantity_found = 0
    and not op.replaced
    and ora.product_alternative_id is not null
    and o.actual_delivery_time >= {{date_from}} - interval '1 day' 
    and o.actual_delivery_time < {{date_to}} + interval '2 day'
    and o.actual_delivery_time at time zone gc.timezone >= {{date_from}} 
    and o.actual_delivery_time at time zone gc.timezone < {{date_to}} + interval '1 day'
    and o.currency = 'MXN'
    and o.order_kind = 'NORMAL'
    and o.status = 'DELIVERED'
order by order_id, product_id
