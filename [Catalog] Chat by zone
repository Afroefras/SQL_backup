select
    gc.name as city,
    goz.id as zone_id,
    goz.name as zone,
    o.user_id,
    o.id,
    cp.description as custom_product,
    op.custom_request,
    cm.text as chat_messages
from orders_orderchatmessage cm 
    join orders_order o on o.id = cm.order_id
    join orders_ordercustomproduct cp on cp.order_id = o.id
    join orders_orderproduct op on op.order_id = o.id
    join catalog_storebranch sb on sb.id = o.store_branch_id
    join geo_city gc on gc.id = sb.city_id
    join geo_opzone goz on ST_Intersects(goz.multi_poly, sb.picking_point) and not goz.deleted
where 1=1
    [[and gc.id = {{city_id}}]]
    and o.actual_delivery_time >= {{desde}} - interval '2 day'
    and o.actual_delivery_time < {{hasta}} + interval '2 day'
    and (cp.description is not null or op.custom_request is not null or cm.text is not null)
    and o.currency = 'MXN'
    and o.order_kind = 'NORMAL';
