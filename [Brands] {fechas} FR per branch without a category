select
    s.id as store_id,
    s.name as store_name,
    sb.id as store_branch_id,
    sb.slug as store_branch_name,
    sum(o.qty_products_found)*1.00 / sum(o.qty_products_ordered) as found_rate_original,
    count(op.quantity_found) filter(where op.quantity_found > 0)*1.00 / count(op.quantity) as found_rate_items,
    sum(op.quantity_found)*1.00 / sum(op.quantity) as found_rate_qty
from orders_orderproduct op
    join orders_order o on o.id = op.order_id
        and o.currency = 'BRL'
        and o.actual_delivery_time >= {{desde}} - interval '1 day' 
        and o.actual_delivery_time < {{hasta}} + interval '2 day' 
        and o.status = 'DELIVERED'
        and o.order_kind = 'NORMAL'
    join catalog_product p on p.id = op.product_id
        and p.category_id != 1526
    join catalog_storebranch sb on sb.id = o.store_branch_id 
        and o.actual_delivery_time at time zone sb.timezone >= {{desde}} 
        and o.actual_delivery_time at time zone sb.timezone < {{hasta}} + interval '1 day'
    join catalog_store s on s.id = sb.store_id 
        and s.country = 'BR'
group by 1,2,3,4
order by 1,5;
