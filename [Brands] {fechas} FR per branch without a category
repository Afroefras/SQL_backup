select
    to_char(o.actual_delivery_time at time zone sb.timezone,'yyyy-mm-dd') as date,
    s.id as store_id,
    s.name as store_name,
    sb.id as store_branch_id,
    sb.slug as store_branch_name,
    count(distinct o.id) as total_orders,
    sum(o.qty_products_found) as products_found,
    sum(o.qty_products_ordered) as products_ordered,
    count(op.quantity_found) filter(where op.quantity_found > 0) as items_found,
    count(op.quantity) as items_ordered,
    sum(op.quantity_found) as qty_found,
    sum(op.quantity) as qty_ordered
from orders_orderproduct op
    join orders_order o on o.id = op.order_id
        and o.currency = 'BRL'
        and o.actual_delivery_time >= {{desde}} - interval '1 day' 
        and o.actual_delivery_time < {{hasta}} + interval '2 day' 
        and o.status = 'DELIVERED'
        and o.order_kind = 'NORMAL'
    join catalog_product p on p.id = op.product_id
        and p.category_id != 1526
    join catalog_storebranch sb on sb.id = o.store_branch_id
        and o.actual_delivery_time at time zone sb.timezone >= {{desde}} 
        and o.actual_delivery_time at time zone sb.timezone < {{hasta}} + interval '1 day'
    join catalog_store s on s.id = sb.store_id 
        and s.country = 'BR'
group by 1,2,3,4,5
order by 1 asc, 6 desc;
