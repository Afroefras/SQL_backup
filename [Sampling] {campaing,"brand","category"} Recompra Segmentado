with gift_products as
    (select 
        pp.id as project_id,
        pp.name as project_name,
        pp.initial_budget,
        pp.available_budget,
        gpc.campaign_ptr_id,
        unnest(gpc.products_barcodes)::numeric as product_id
    from promotions_giftproductcampaign gpc
        join promotions_promotionalprojectcomponent ppc on ppc.component_id = gpc.campaign_ptr_id and ppc.component_content_type_id = 447
        join promotions_promotionalproject pp on pp.id = ppc.promotional_project_id and pp.id = {{project_id}}
    group by 1,2,3,4,5
    ),
    
    gift_orders as 
    (select
        gp.campaign_ptr_id,
        o.id as order_id,
        o.actual_delivery_time as received_at,
        o.user_id
    from promotions_campaign c
        join gift_products gp on gp.campaign_ptr_id = c.id
        join promotions_ordercampaign oc on oc.campaign_id = c.id 
        join orders_order o on o.id = oc.order_id
    where 1=1
        and o.status = 'DELIVERED'
        [[and o.actual_delivery_time >= {{desde}} - interval '1 day']]
        [[and o.actual_delivery_time < {{hasta}} + interval '2 day']]
        and o.currency = {{currency}}
    ),
    
    target_users as 
    (select
        g.name as city_name,
        sb.name as store_branch_name,
        o.id as order_id,
        o.user_id,
        p.id as product_id,
        p.name as product_name
    from orders_order o
        join catalog_storebranch sb on sb.id = o.store_branch_id
        join geo_city g on g.id = sb.city_id
        join gift_orders go on go.user_id = o.user_id
        join orders_orderproduct op on op.order_id = o.id
        join catalog_product p on p.id = op.product_id
    where 1=1
        and o.status = 'DELIVERED'
		and o.order_kind = 'NORMAL'
		--se compró después de recibir el sampling
		and (o.actual_delivery_time)::date > go.received_at
		--se compró a lo más N días después de recibir el sampling
		and (o.actual_delivery_time)::date < go.received_at + interval '60 days'
        and o.currency = {{currency}}
    )
    
select 
    gp.*,
    tu.product_name,
    tu.city_name,
    tu.store_branch_name,
    count(distinct go.user_id) as sampled_users,
    count(distinct tu.user_id) as repurchase_users,
    count(distinct tu.order_id) as repurchase_orders,
    count(tu.product_id) as repurchase_products
from gift_products gp
    join gift_orders go on go.campaign_ptr_id = gp.campaign_ptr_id
    join target_users tu on tu.product_id = gp.product_id
group by 1,2,3,4,5,6,7,8,9
order by repurchase_users desc;
