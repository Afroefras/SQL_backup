with promo_orders as(
    select 
        o.user_id,
        o.id as order_id,
        'promo' as order_type
    from orders_order o
        left join user_store_userstorefirstdelivery usu on o.uuid = usu.order_uuid
        left join user_store_firstdeliveryredemption usf on usu.order_uuid = usf.order_uuid
    where 1=1
        and usf.campaign_uuid = 'd1337462-713f-4581-8fa7-19030eaeb031'
        [[and o.created >= {{promo_from}} - interval '2 day']]
        [[and o.created < {{promo_until}} + interval '2 day']]
        [[and o.created at time zone 'America/Mexico_City' >= {{promo_from}}]]
        [[and o.created at time zone 'America/Mexico_City' < {{promo_until}} + interval '1 day']]
        and o.status = 'DELIVERED'
        and o.order_kind = 'NORMAL' 
        and o.currency = 'MXN'
    group by 1,2
    )

select *,
    to_char(order_date,'YYYY') as year,
    to_char(order_date,'MM') as month,
    to_char(order_date,'IW') as week,
    case when days_elapsed = days_elapsed_store then true else false end as next_order_same_store
from (
    select *,
        extract(epoch from order_date - lag(order_date) over (partition by user_id order by order_date))/86400 as days_elapsed,
        extract(epoch from order_date - lag(order_date) over (partition by user_id,store_id order by order_date))/86400 as days_elapsed_store,
        case when n_order = 1 then 'new' else 'not_new' end as client,
        case when n_order_same_store = 1 then 'new' else 'not_new' end as client_store
    from (
        select
            o.actual_delivery_time at time zone sb.timezone as order_date,
            s.country,
            gc.name as city,
            coalesce(goz.name,'unknown') as zone,
            s.id as store_id,
            s.name as store_name,
            o.user_id,
            o.id as order_id,
            row_number() over (partition by o.user_id order by o.id) as n_order,
            row_number() over (partition by o.user_id,sb.store_id order by o.id) as n_order_same_store,
            coalesce(promo.order_type,'normal') as order_type,
            case when o.uber_order_uuid is null then 'Cornershop' else 'Uber' end as platform,
            coalesce(o.total_receipt,0) as total_receipt,
            coalesce(o.qty_products_ordered,0) as requested,
            coalesce(o.qty_products_found,0) as found,
            coalesce(o.qty_products_replaced,0) as replaced
        from promo_orders po
            join orders_order o on o.user_id = po.user_id
            left join promo_orders promo on promo.order_id = o.id
            join catalog_storebranch sb on sb.id = o.store_branch_id
            join catalog_store s on s.id = sb.store_id
            join geo_city gc on gc.id = sb.city_id
            left join geo_opzone goz on ST_Intersects(goz.multi_poly, sb.picking_point) and not goz.deleted
        where 1=1
            [[and o.actual_delivery_time >= {{order_from}} - interval '2 day']]
            [[and o.actual_delivery_time < {{order_until}} + interval '2 day']]
            [[and o.actual_delivery_time at time zone sb.timezone >= {{order_from}}]]
            [[and o.actual_delivery_time at time zone sb.timezone < {{order_until}} + interval '1 day']]
            and o.status = 'DELIVERED'
            and o.order_kind = 'NORMAL' 
            and o.currency = 'MXN'
        ) a
    ) b
