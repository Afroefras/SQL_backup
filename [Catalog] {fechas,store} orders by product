select 
    op.product_id,
    sum(op.quantity) as requested,
    sum(op.quantity_found) as found,
    count(distinct o.id) as orders,
    sum(coalesce(op.quantity_found*op.branch_price,0)) as sales
from orders_orderproduct op
    join orders_order o on o.id = op.order_id
    join catalog_storebranch sb on sb.id = o.store_branch_id
where 1=1
    and o.currency = 'MXN'
    and o.actual_delivery_time >= {{desde}} - interval '1 day' 
    and o.actual_delivery_time < {{hasta}} + interval '2 day'
    and o.actual_delivery_time at time zone sb.timezone between {{desde}} and {{hasta}} + interval '1 day'
    and o.status = 'DELIVERED'
    and o.order_kind = 'NORMAL'
    and sb.store_id = {{store_id}}
    and op.product_id in (
        601092,383861,383762,352928,384310,383819,598173,384071,1217172,383908,384216,383889,384279,1124178,384129,383854,323736,1603810,1993289,384058,383802,384080,384075,1216661,383862,384595,368277,594615,383952,1579801,383916,383779,384016,384054,383703,383746,383836,2408323,353229,384260,1149644,384143,383910,383895,1217385,361105,340517,356499,383933,313193,383909,493895,357317,384097,383929,422352,384093,280337,384055,383758,384035,383849,2408324,1155402,1155818,383877,355943,1155815,375340,384015,383780,362373,384140,605904,2279192,383947,2043400,1245639,384291,383869,383898,383878,274325,1603970,384094,383943,1245642,383851,353249,1008145,383833,1012021,384100,357153,1009515,1155632,383706,383689,383902,374966,384051,1159501,2161177,1004406,597804,384099,1604152,384107,1001762,383691,137643,384101,384121,320467,383742,356077,384061,384264,383857,368209,383828,1993264,384013,375291,383882,383906,384203,2161179,383793,383887,323718,383925,390583,94260,129848,389526,1871167,2407329,384311,384018,383622,384294,2224607,384193,384137,383890,139322,383296,384292,544010,2255908,383948,598176,324439,383770,383879,380342,384067,383471,1898114,357490,384280,384064,383658,1604151,313349,383863,384032,384052,1228263,383708,321375,594573,383825,602614,384041,344148,1217050,320464,384102,383777,384031,141675,383615,384025,384109,384154,384008,383803,384046,2060202,383859,1230746,2407327,354295,383816,383886,385216,374899,182471,1259716,383896,339807,383894,375796,383679,375066,384077,383764,346098,384038,383688,384314,384111,137620,344260,384024,384056,220847,383944,384082,344375,383937,383669,383867,383912,389157,383919,384040,383348,1129115,591566,3018258,383773,384085,366077,383705,390537,384036,384091,383945,2408561,384042,384053,383870,384063,1160121,384050,384148,384306,384313,384059,383698,383715,383844,365045,383738,383674,384124,384110,383914,383796,384108,137464,383942,383748,383873,384017,383904,384274,384204,383953,383931,1604567,2021245,383701,607112,383868,384005,383872,384145,383951,384123,1897939,383799,2043290,384023,383941,384084,384112,1499513,323640,598282,384012,1150186,191072,383692,383823,384116,384095,1155405,355526,605751,317838,342000,1152045,362382,384106,383815,383781,383831,383893,2408562,383620,257953,383826,384269,383888,384072,383853,383794,383891,383697,1155450,384062,323514,315878,129840,137533,384078,386827,352963,383254,384278,383745,383885,384288,384202,597444,2334719,383881,1217210,383940,1233777,281975,384142,383766,383949,1010754,384065,343770,141532,2065172,384293,383913,384092,597355,384211,383926,383763,383892,355389,383835,384259,384073,606218,604789,384026,390055,384150,210222,375179,384132,1010426,383950,374921,383845,383818,273803,320514,383778,384019,352948,281333,384029,383449,384049,383824,383875,390357,384027,140128,384207,2060196,170519,384155,2457798,383922,689865,383726,614376,606366,383837,363385,317836,362442,1216321,384074,383954,383721,384034,2161160,384022,384096,383817,383955,1245656,383693,384039,383695,341909,384033,383864,383915,339806,362683,384020,594908,383663,273774,312416,383720,1499489,375659,383390,134134,384011,383743,446841,384010,1604553,384272,384171,383545,384131,367441,384166,384069,384090,593224,1001777,384043,2407326,384146,383897,383364,592694,384271,384045,598383,487841,383924,384267,383704,384057,140496,1006811,383717,141491,544015,384175,323719,344896,368480,384083,384141,384103,166392,384174,383907,384115,384308,1240827,384021,384169,2113824,383673,334121,384167,384206,341570,314019,383814,129841,383830,383921,383927,383900,383934,383932,384159,1001769,383686,313182,598380,345766,384240,544002,317839,384081,384138,384098,383938,1499491,384305,367567,1604154,390265,383630,1603945,384200,383918,384028,383834,383880,383690,384249,384070,383685,384030,140071,383804,383847,597483,383676,384270,1245634,383876,384066,383860,383865,384233,384139,383684
    )

group by 1
order by orders desc;
