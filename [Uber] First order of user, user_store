select *, store_and_user_first_orders - user_first_orders as just_store_first_order from
(select 
    concat(s.id, ' - ', s.name) as store,
    concat(gc.id, ' - ', gc.name) as city,
    case when o.platform = 0 and (o.client_bundle like '%uber%' or (o.client_bundle is null and u.tmp_uber_original_segmentation = 'Uber')) then 'Uber' else 'Cornershop' end as platform,
    sum(o.total_receipt) as sales,
    sum(o.qty_products_found + o.qty_products_replaced) as products_delivered,
    count(distinct o.id) as orders,
    count(distinct o.id) filter (where o.total_receipt > 1000) as orders_greater_than_1K,
    count(distinct o.id) filter (where date_trunc('day', o.actual_delivery_time) = date_trunc('day', coalesce(u.date_first_order, u.created))) as user_first_orders,
    count(distinct date_trunc('day', o.actual_delivery_time)) filter (where date_trunc('day', o.actual_delivery_time) = fso.store_first_order) as store_and_user_first_orders
from orders_order o
    join catalog_storebranch sb on sb.id = o.store_branch_id
    join catalog_store s on s.id = sb.store_id
    join geo_city gc on gc.id = sb.city_id
    join crm_users_view u on u.id = o.user_id
    join (
        select
            o.user_id,
            date_trunc('day', min(o.actual_delivery_time)) as store_first_order
        from orders_order o 
            join catalog_storebranch sb on sb.id = o.store_branch_id
        where 1=1
            and sb.store_id = 3730
            and o.currency = 'MXN'
            and o.status = 'DELIVERED'
            and o.order_kind = 'NORMAL'
        group by 1
        ) fso on fso.user_id = u.id
        
where 1=1
    and s.id = 3730
    and o.actual_delivery_time >= '2021-10-01'
    and o.actual_delivery_time <= '2021-10-31'
    and o.currency = 'MXN'
    and o.status = 'DELIVERED'
    and o.order_kind = 'NORMAL'
group by 1,2,3) a;
