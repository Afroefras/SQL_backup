select 
    o.id as order_id,
    concat(string_agg(concat(op.custom_request,' :: ',p.name),'_ '),'_ ',string_agg(cp.description,'_ ')) as text
from orders_orderproduct op
    join orders_order o on o.id = op.order_id
    join catalog_product p on p.id = op.product_id
    join catalog_productcategorization pc on pc.product_id = p.id
    join catalog_category c on c.id = pc.category_id
    join catalog_storebranch sb on sb.id = o.store_branch_id
    full join orders_ordercustomproduct cp on cp.order_id = o.id
where 1=1
    [[and sb.city_id in ({{city_id}})]]
    [[and sb.store_id in ({{store_id}})]]
    [[and c.id in ({{category_id}})]]
    and (op.custom_request <> '' or cp.description <> '')
    and o.currency = 'MXN'
    and o.actual_delivery_time >= {{desde}} - interval '2 day'
    and o.actual_delivery_time < {{hasta}} + interval '2 day'
    and o.actual_delivery_time at time zone sb.timezone >= {{desde}}
    and o.actual_delivery_time at time zone sb.timezone < {{hasta}} + interval '1 day'
group by 1
