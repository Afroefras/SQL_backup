with product_filter as(
    --S贸lo productos de la CPG en cuesti贸n, en MX
    select
        cp.id as product_id,
        cb.id as brand_id,
        cb.name as brand_name
    from catalog_product cp
        join catalog_brand cb on cb.id = cp.brand_id
        join brandcenter_brandcentercpg_brands bbb on bbb.brand_id = cp.brand_id
        join brandcenter_brandcentercpg bbc on bbc.id = bbb.brandcentercpg_id and bbc.country_id = 'MX'
    where bbc.id = {{cpg}}),
    
    --Contar 贸rdenes por usuarios-brand
    user_order_filter as (
	select
		o.user_id,
		pf.brand_id,
		pf.brand_name,
		count(distinct o.id) as tot_orders
	from orders_order o
		join orders_orderproduct op on op.order_id = o.id
		join product_filter pf on pf.product_id = op.product_id
	where 1=1
    	and o.actual_delivery_time >= {{desde}}::date - interval '1 day'
        and o.actual_delivery_time < {{hasta}}::date + interval '1 day'
        and o.order_kind = 'NORMAL'
        and o.status = 'DELIVERED'
    group by 1,2,3)

--Agrupar promedio de 贸rdenes por usuario a nivel brand    
select
    uof.brand_id,
    uof.brand_name,
    avg(uof.tot_orders)
from user_order_filter uof
group by 1,2
order by 3 desc;
