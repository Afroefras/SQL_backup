select 
    year,week,store_id,store,city,
    --branch,
    count(distinct order_id) filter (where is_canceled) as canceled_orders,
    count(distinct order_id) filter (where not is_canceled and status='DELIVERED') as delivered_orders,
    sum(requested_products) as requested,
    sum(not_found_products) as not_found
from(
    select
        to_char(o.promised_delivery_time at time zone sb.timezone, 'YYYY') as year,
        to_char(o.promised_delivery_time at time zone sb.timezone, 'IW') as week,
        s.id as store_id,
        s.name as store,
        gc.name as city,
        --sb.name as branch,
        o.id as order_id,
        o.status,
        case when(1=1
                and o.status = 'CANCELED_BY_CM'
                and ceo.operation_type = 'CANCEL_ORDER'
                and ceo.detail in ('CLIENT_ASKED_NO_STOCK', 'CLIENT_DIDNT_ANSWER_NO_STOCK','NO_STOCK')
                and ceo.reference_content_type_id = 25
                ) then true else false end as is_canceled,
        count(op.quantity) filter(where op.quantity > 0) as requested_products,
        count(op.id) filter (where op.quantity_found = 0 or op.quantity_found is null) as not_found_products
    from orders_orderproduct op
        join orders_order o on o.id = op.order_id
        join catalog_storebranch sb on sb.id = o.store_branch_id
        join geo_city gc on gc.id = sb.city_id
        join catalog_store s on s.id = sb.store_id
        join common_eventoperation ceo on o.id = ceo.reference_id
    where 1=1
        and o.promised_delivery_time >= date_trunc('week',current_date) - interval '2 week 1 day'
        and o.promised_delivery_time < date_trunc('week',current_date) - interval '1 week' + interval '1 day'
        and o.promised_delivery_time at time zone sb.timezone >= date_trunc('week',current_date) - interval '2 week'
        and o.promised_delivery_time at time zone sb.timezone < date_trunc('week',current_date)- interval '1 week'
        and o.order_kind = 'NORMAL'
        and s.country = 'MX'
        and s.status = 'ACTIVE'
        and sb.active
    group by 1,2,3,4,5,6,7,8--,9
    ) a
group by 1,2,3,4,5--,6
having count(distinct order_id) filter (where is_canceled) > 0;
